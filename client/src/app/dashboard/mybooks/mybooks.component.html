<div class="mybooks-container">
  <div class="page-header">
    <h1 class="page-title">My Books</h1>
    <button class="btn-add-book" (click)="openAddBookModal()">
      <span class="plus-icon">+</span> Add Book
    </button>
  </div>

  <div class="tabs-container">
    <div class="tabs-header">
      <button class="tab-button" [class.active]="activeTab === 'mybooks'" (click)="switchTab('mybooks')">
        My Books
        <span class="badge" *ngIf="activeTab === 'mybooks' && totalElements">{{ totalElements }}</span>
      </button>
      <button class="tab-button" [class.active]="activeTab === 'returned'" (click)="switchTab('returned')">
        Returned
        <span class="badge" *ngIf="activeTab === 'returned' && totalElements">{{ totalElements }}</span>
      </button>
      <button class="tab-button" [class.active]="activeTab === 'borrowed'" (click)="switchTab('borrowed')">
        Borrowed
        <span class="badge" *ngIf="activeTab === 'borrowed' && totalElements">{{ totalElements }}</span>
      </button>
      <button class="tab-button" [class.active]="activeTab === 'requested'" (click)="switchTab('requested')">
        Requested
        <span class="badge" *ngIf="activeTab === 'requested' && totalElements">{{ totalElements }}</span>
      </button>
    </div>

    <div class="tabs-content">
      <!-- My Books Tab -->
      <div class="tab-panel" *ngIf="activeTab === 'mybooks'">
        <div class="loading" *ngIf="loading">
          <p>Loading...</p>
        </div>
        <div class="error" *ngIf="error">
          <p>{{ error }}</p>
        </div>
        <div class="books-grid" *ngIf="!loading && !error && myBooks.length">
          <div class="book-card" *ngFor="let book of myBooks">
            <div class="book-image">
              <img *ngIf="book.cover" [src]="'data:image/jpeg;base64,' + book.cover" [alt]="book.title">
              <img *ngIf="!book.cover && book.coverUrl" [src]="book.coverUrl" [alt]="book.title">
              <div *ngIf="!book.cover && !book.coverUrl" class="book-cover-emoji">üìö</div>
            </div>
            <div class="book-details">
              <h3>{{ book.title }}</h3>
              <p class="author">{{ book.authorName }}</p>
              <p class="description" *ngIf="book.synopsis">{{ book.synopsis }}</p>
              <p class="isbn" *ngIf="book.isbn">ISBN: {{ book.isbn }}</p>
            </div>
            <div class="book-meta">
              <span class="rate" *ngIf="book.rate">‚≠ê {{ book.rate }}</span>
              <span class="badge-fav" *ngIf="book.favourite">‚ù§Ô∏è Favourite</span>
              <span class="badge-read" *ngIf="book.read">üìñ Read</span>
              <span class="badge-archived" *ngIf="book.archived">üì¶ Archived</span>
              <span class="badge-shareable" *ngIf="book.shareable">üîó Shareable</span>
            </div>
            <div class="book-actions">
              <button class="btn-compact"><span class="icon">üëÅÔ∏è</span> View</button>
              <button class="btn-compact"><span class="icon">‚úèÔ∏è</span> Edit</button>
              <button class="btn-compact"><span class="icon">üì¶</span> Archive</button>
              <button class="btn-compact" (click)="deleteBook(book.id)"><span class="icon">üóëÔ∏è</span> Delete</button>
            </div>
          </div>
        </div>
        <div class="empty-state" *ngIf="!loading && !error && !myBooks.length">
          <p>You don't have any books yet.</p>
        </div>
        
        <!-- Pagination Controls -->
        <div class="pagination" *ngIf="totalPages > 1 && !loading">
          <button class="pagination-btn" (click)="previousPage()" [disabled]="isFirstPage">
            ‚Üê Previous
          </button>

          <div class="pagination-info">
            <span>Page {{ currentPage + 1 }} / {{ totalPages }} ‚Ä¢ Size: {{ pageSize }}</span>
          </div>

          <button class="pagination-btn" (click)="nextPage()" [disabled]="isLastPage">
            Next ‚Üí
          </button>
        </div>
      </div>

      <!-- Returned Tab -->
      <div class="tab-panel" *ngIf="activeTab === 'returned'">
        <div class="loading" *ngIf="loading">
          <p>Loading...</p>
        </div>
        <div class="error" *ngIf="error">
          <p>{{ error }}</p>
        </div>
        <div class="books-grid" *ngIf="!loading && !error && returnedBooks.length">
          <div class="book-card" *ngFor="let book of returnedBooks">
            <div class="book-image">
              <img *ngIf="book.cover" [src]="'data:image/jpeg;base64,' + book.cover" [alt]="book.title">
              <img *ngIf="!book.cover && book.coverUrl" [src]="book.coverUrl" [alt]="book.title">
              <div *ngIf="!book.cover && !book.coverUrl" class="book-cover-emoji">üìö</div>
            </div>
            <div class="book-details">
              <h3>{{ book.title }}</h3>
              <p class="author">{{ book.authorName }}</p>
            </div>
            <div class="book-meta">
              <!-- Empty for returned books -->
            </div>
            <div class="book-actions">
              <!-- No actions for returned books -->
            </div>
          </div>
        </div>
        <div class="empty-state" *ngIf="!loading && !error && !returnedBooks.length">
          <p>No returned books.</p>
        </div>
        
        <!-- Pagination Controls -->
        <div class="pagination" *ngIf="totalPages > 1 && !loading">
          <button class="pagination-btn" (click)="previousPage()" [disabled]="isFirstPage">
            ‚Üê Previous
          </button>

          <div class="page-numbers">
            <button *ngFor="let pageNum of pageNumbers" 
                    class="page-number" 
                    [class.active]="pageNum === currentPage"
                    (click)="goToPage(pageNum)">
              {{ pageNum + 1 }}
            </button>
          </div>

          <div class="pagination-info">
            <span>Page {{ currentPage + 1 }} / {{ totalPages }} ‚Ä¢ Size: {{ pageSize }}</span>
          </div>

          <button class="pagination-btn" (click)="nextPage()" [disabled]="isLastPage">
            Next ‚Üí
          </button>
        </div>
      </div>

      <!-- Borrowed Tab -->
      <div class="tab-panel" *ngIf="activeTab === 'borrowed'">
        <div class="loading" *ngIf="loading">
          <p>Loading...</p>
        </div>
        <div class="error" *ngIf="error">
          <p>{{ error }}</p>
        </div>
        <div class="books-grid" *ngIf="!loading && !error && borrowedBooks.length">
          <div class="book-card" *ngFor="let book of borrowedBooks">
            <div class="book-image">
              <img *ngIf="book.cover" [src]="'data:image/jpeg;base64,' + book.cover" [alt]="book.title">
              <img *ngIf="!book.cover && book.coverUrl" [src]="book.coverUrl" [alt]="book.title">
              <div *ngIf="!book.cover && !book.coverUrl" class="book-cover-emoji">üìö</div>
            </div>
            <div class="book-details">
              <h3>{{ book.title }}</h3>
              <p class="author">{{ book.authorName }}</p>
            </div>
            <div class="book-meta">
              <!-- Empty for rented books -->
            </div>
            <div class="book-actions">
              <!-- No actions for rented books -->
            </div>
          </div>
        </div>
        <div class="empty-state" *ngIf="!loading && !error && !borrowedBooks.length">
          <p>No currently borrowed books.</p>
        </div>
        
        <!-- Pagination Controls -->
        <div class="pagination" *ngIf="totalPages > 1 && !loading">
          <button class="pagination-btn" (click)="previousPage()" [disabled]="isFirstPage">
            ‚Üê Previous
          </button>

          <div class="page-numbers">
            <button *ngFor="let pageNum of pageNumbers" 
                    class="page-number" 
                    [class.active]="pageNum === currentPage"
                    (click)="goToPage(pageNum)">
              {{ pageNum + 1 }}
            </button>
          </div>

          <div class="pagination-info">
            <span>Page {{ currentPage + 1 }} / {{ totalPages }} ‚Ä¢ Size: {{ pageSize }}</span>
          </div>

          <button class="pagination-btn" (click)="nextPage()" [disabled]="isLastPage">
            Next ‚Üí
          </button>
        </div>
      </div>

      <!-- Requested Tab -->
      <div class="tab-panel" *ngIf="activeTab === 'requested'">
        <div class="loading" *ngIf="loading">
          <p>Loading...</p>
        </div>
        <div class="error" *ngIf="error">
          <p>{{ error }}</p>
        </div>
        <div class="books-grid" *ngIf="!loading && !error && requestedBooks.length">
          <div class="book-card" *ngFor="let book of requestedBooks">
            <div class="book-image">
              <img *ngIf="book.cover" [src]="'data:image/jpeg;base64,' + book.cover" [alt]="book.title">
              <img *ngIf="!book.cover && book.coverUrl" [src]="book.coverUrl" [alt]="book.title">
              <div *ngIf="!book.cover && !book.coverUrl" class="book-cover-emoji">üìö</div>
            </div>
            <div class="book-details">
              <h3>{{ book.title }}</h3>
              <p class="author">{{ book.authorName }}</p>
              <p class="isbn" *ngIf="book.isbn">ISBN: {{ book.isbn }}</p>
              <p class="requester" *ngIf="book.requesterName">Requested by: {{ book.requesterName }}</p>
            </div>
            <div class="book-meta">
              <span class="rate" *ngIf="book.rate">‚≠ê {{ book.rate }}</span>
              <span class="badge-approved" *ngIf="book.requestApproved">‚úÖ Approved</span>
              <span class="badge-pending" *ngIf="book.requested && !book.requestApproved">‚è≥ Pending</span>
            </div>
            <div class="book-actions">
              <button class="btn-compact" (click)="approveRequest(book.id)"><span class="icon">‚úîÔ∏è</span> Approve</button>
              <button class="btn-compact" (click)="rejectRequest(book.id)"><span class="icon">‚ùå</span> Reject</button>
            </div>
          </div>
        </div>
        <div class="empty-state" *ngIf="!loading && !error && !requestedBooks.length">
          <p>No pending requests.</p>
        </div>
        
        <!-- Pagination Controls -->
        <div class="pagination" *ngIf="totalPages > 1 && !loading">
          <button class="pagination-btn" (click)="previousPage()" [disabled]="isFirstPage">
            ‚Üê Previous
          </button>

          <div class="pagination-info">
            <span>Page {{ currentPage + 1 }} / {{ totalPages }} ‚Ä¢ Size: {{ pageSize }}</span>
          </div>

          <button class="pagination-btn" (click)="nextPage()" [disabled]="isLastPage">
            Next ‚Üí
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Book Popup Component -->
<app-bookpopup [isOpen]="showAddBookModal" [mode]="'add'" (closePopup)="closeAddBookModal()"
  (bookSaved)="handleBookSaved($event)">
</app-bookpopup>